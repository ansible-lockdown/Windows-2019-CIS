---

- name: "9.1.1 | GPO | Ensure 'Windows Firewall: Domain: Firewall state' is set to 'On (recommended)'"
  when:
    - win19cis_rule_9_1_1
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.1
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\Windowsfirewall\Domainprofile"
    $registryValueName = "EnableFirewall"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_1_1_results.stdout'
  register: rule_9_1_1_results

- name: "9.1.2 | GPO | Ensure 'Windows Firewall: Domain: Inbound connections' is set to 'Block (default)'"
  when:
    - win19cis_rule_9_1_2
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.2
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\Windowsfirewall\Domainprofile"
    $registryValueName = "DefaultInboundAction"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_1_2_results.stdout'
  register: rule_9_1_2_results

- name: "9.1.3 | GPO | Ensure 'Windows Firewall: Domain: Settings: Display a notification' is set to 'No'"
  when:
    - win19cis_rule_9_1_3
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.3
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\Windowsfirewall\Domainprofile"
    $registryValueName = "DisableNotifications"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_1_3_results.stdout'
  register: rule_9_1_3_results

- name: "9.1.4 | GPO | Ensure 'Windows Firewall: Domain: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/domainfw.log'"
  when:
    - win19cis_rule_9_1_4
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.4
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging"
    $registryValueName = "LogFilePath"
    $type = "String"
    $desiredValue = '{{ win19cis_domain_firewall_log_path }}'

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_1_4_results.stdout'
  register: rule_9_1_4_results

- name: "9.1.5 | GPO | Ensure 'Windows Firewall: Domain: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  when: win19cis_rule_9_1_5
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.5
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  block:
    - name: "9.1.5 | GPO | Ensure 'Windows Firewall: Domain: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Apply Settings To Registry."
      when:
        - "'(Skipped)' not in item"
        - win19cis_domain_firewall_log_size >= 16384
      ansible.windows.win_shell: |
        $gpoName = "{{ item }}"
        $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging"
        $registryValueName = "LogFileSize"
        $type = "DWORD"
        $desiredValue = {{ win19cis_domain_firewall_log_size }}

        # Get the current value of the registry key in the GPO
        $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

        # Check if the current value is equal to the desired value
        if ($currentValue -ne $desiredValue) {
            # If not, set the registry value to the desired value
            Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
            Write-Output "Patched"
        } else {
            Write-Output "No Change Needed"
        }
      loop:
        - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
        - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
      loop_control:
        label: "{{ item }}"
      changed_when: '"Patched" in rule_9_1_5_results.stdout'
      register: rule_9_1_5_results

    - name: "9.1.5 | AUDIT | Ensure 'Windows Firewall: Domain: Logging: Size limit (KB)' is set to '16,384 KB or greater'. | Warning Check For Variable Standards."
      when: win19cis_domain_firewall_log_size < 16384
      ansible.builtin.debug:
        msg:
          - "Warning!! You have an invalid size set for win19cis_domain_firewall_log_size please read"
          - "the notes for the variable and make the necessary change to the variable to be in compliance."

    - name: "9.1.5 | AUDIT | Ensure 'Windows Firewall: Domain: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Warn Count."
      when: win19cis_domain_firewall_log_size < 16384
      ansible.builtin.import_tasks:
        file: warning_facts.yml
      vars:
        warn_control_id: '9.1.5'

- name: "9.1.6 | GPO | Ensure 'Windows Firewall: Domain: Logging: Log dropped packets' is set to 'Yes'"
  when:
    - win19cis_rule_9_1_6
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.6
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.3.1
    - NIST800-171_3.3.2
    - NIST800-171_3.3.6
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_AU-3
    - NIST800-53_AU-3_1
    - NIST800-53_AU-7
    - NIST800-53_AU-12
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_AU-3
    - NIST800-53R5_AU-3_1
    - NIST800-53R5_AU-7
    - NIST800-53R5_AU-12
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging"
    $registryValueName = "LogDroppedPackets"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_1_6_results.stdout'
  register: rule_9_1_6_results

- name: "9.1.7 | GPO | Ensure 'Windows Firewall: Domain: Logging: Log successful connections' is set to 'Yes'"
  when:
    - win19cis_rule_9_1_7
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.1.7
    - patch
    - firewall
    - domain
    - gpo
    - NIST800-171_3.3.1
    - NIST800-171_3.3.2
    - NIST800-171_3.3.6
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_AU-3
    - NIST800-53_AU-3_1
    - NIST800-53_AU-7
    - NIST800-53_AU-12
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_AU-3
    - NIST800-53R5_AU-3_1
    - NIST800-53R5_AU-7
    - NIST800-53R5_AU-12
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging"
    $registryValueName = "LogSuccessfulConnections"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_1_7_results.stdout'
  register: rule_9_1_7_results

- name: "9.2.1 | GPO | Ensure 'Windows Firewall: Private: Firewall state' is set to 'On (recommended)'"
  when:
    - win19cis_rule_9_2_1
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.1
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile"
    $registryValueName = "EnableFirewall"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_2_1_results.stdout'
  register: rule_9_2_1_results

- name: "9.2.2 | GPO | Ensure 'Windows Firewall: Private: Inbound connections' is set to 'Block (default)'"
  when:
    - win19cis_rule_9_2_2
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.2
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile"
    $registryValueName = "DefaultInboundAction"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_2_2_results.stdout'
  register: rule_9_2_2_results

- name: "9.2.3 | GPO | Ensure 'Windows Firewall: Private: Settings: Display a notification' is set to 'No'"
  when:
    - win19cis_rule_9_2_3
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.3
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile"
    $registryValueName = "DisableNotifications"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_2_3_results.stdout'
  register: rule_9_2_3_results

- name: "9.2.4 | GPO | Ensure 'Windows Firewall: Private: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/privatefw.log'"
  when:
    - win19cis_rule_9_2_4
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.4
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging"
    $registryValueName = "LogFilePath"
    $type = "String"
    $desiredValue = '{{ win19cis_private_firewall_log_path }}'

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_2_4_results.stdout'
  register: rule_9_2_4_results

- name: "9.2.5 | GPO | Ensure 'Windows Firewall: Private: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  when: win19cis_rule_9_2_5
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.5
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  block:
    - name: "9.2.5 | GPO | Ensure 'Windows Firewall: Private: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Apply Settings To Registry."
      when:
        - "'(Skipped)' not in item"
        - win19cis_private_firewall_log_size >= 16384
      ansible.windows.win_shell: |
        $gpoName = "{{ item }}"
        $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging"
        $registryValueName = "LogFileSize"
        $type = "DWORD"
        $desiredValue = {{ win19cis_private_firewall_log_size }}

        # Get the current value of the registry key in the GPO
        $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

        # Check if the current value is equal to the desired value
        if ($currentValue -ne $desiredValue) {
            # If not, set the registry value to the desired value
            Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
            Write-Output "Patched"
        } else {
            Write-Output "No Change Needed"
        }
      loop:
        - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
        - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
      loop_control:
        label: "{{ item }}"
      changed_when: '"Patched" in rule_9_2_5_results.stdout'
      register: rule_9_2_5_results

    - name: "9.2.5 | AUDIT | Ensure 'Windows Firewall: Private: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Warning Check For Variable Standards."
      when: win19cis_private_firewall_log_size < 16384
      ansible.builtin.debug:
        msg:
          - "Warning!! You have an invalid size set for win19cis_private_firewall_log_size please read"
          - "the notes for the variable and make the necessary change to the variable to be in compliance."

    - name: "9.2.5 | AUDIT | Ensure 'Windows Firewall: Private: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Warn Count."
      when: win19cis_private_firewall_log_size < 16384
      ansible.builtin.import_tasks:
        file: warning_facts.yml
      vars:
        warn_control_id: '9.2.5'

- name: "9.2.6 | GPO | Ensure 'Windows Firewall: Private: Logging: Log dropped packets' is set to 'Yes'"
  when:
    - win19cis_rule_9_2_6
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.6
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.3.1
    - NIST800-171_3.3.2
    - NIST800-171_3.3.6
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_AU-3
    - NIST800-53_AU-3_1
    - NIST800-53_AU-7
    - NIST800-53_AU-12
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_AU-3
    - NIST800-53R5_AU-3_1
    - NIST800-53R5_AU-7
    - NIST800-53R5_AU-12
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging"
    $registryValueName = "LogDroppedPackets"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_2_6_results.stdout'
  register: rule_9_2_6_results

- name: "9.2.7 | GPO | Ensure 'Windows Firewall: Private: Logging: Log successful connections' is set to 'Yes'"
  when:
    - win19cis_rule_9_2_7
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.2.7
    - patch
    - firewall
    - private
    - gpo
    - NIST800-171_3.3.1
    - NIST800-171_3.3.2
    - NIST800-171_3.3.6
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_AU-3
    - NIST800-53_AU-3_1
    - NIST800-53_AU-7
    - NIST800-53_AU-12
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_AU-3
    - NIST800-53R5_AU-3_1
    - NIST800-53R5_AU-7
    - NIST800-53R5_AU-12
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging"
    $registryValueName = "LogSuccessfulConnections"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_2_7_results.stdout'
  register: rule_9_2_7_results

- name: "9.3.1 | GPO | Ensure 'Windows Firewall: Public: Firewall state' is set to 'On (recommended)'"
  when:
    - win19cis_rule_9_3_1
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.1
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile"
    $registryValueName = "EnableFirewall"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_1_results.stdout'
  register: rule_9_3_1_results

- name: "9.3.2 | GPO | Ensure 'Windows Firewall: Public: Inbound connections' is set to 'Block (default)'"
  when:
    - win19cis_rule_9_3_2
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.2
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile"
    $registryValueName = "DefaultInboundAction"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_2_results.stdout'
  register: rule_9_3_2_results

- name: "9.3.3 | GPO | Ensure 'Windows Firewall: Public: Settings: Display a notification' is set to 'No'"
  when:
    - win19cis_rule_9_3_3
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.3
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile"
    $registryValueName = "DisableNotifications"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_3_results.stdout'
  register: rule_9_3_3_results

- name: "9.3.4 | GPO | Ensure 'Windows Firewall: Public: Settings: Apply local firewall rules' is set to 'No'"
  when:
    - win19cis_rule_9_3_4
    - "'(Skipped)' not in item"
    - not win_skip_for_test
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.4
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile"
    $registryValueName = "AllowLocalPolicyMerge"
    $type = "DWORD"
    $desiredValue = 0

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_4_results.stdout'
  register: rule_9_3_4_results

- name: "9.3.5 | GPO | Ensure 'Windows Firewall: Public: Settings: Apply local connection security rules' is set to 'No'"
  when:
    - win19cis_rule_9_3_5
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.5
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile"
    $registryValueName = "AllowLocalIPsecPolicyMerge"
    $type = "DWORD"
    $desiredValue = 0

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_5_results.stdout'
  register: rule_9_3_5_results

- name: "9.3.6 | GPO | Ensure 'Windows Firewall: Public: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/publicfw.log'"
  when:
    - win19cis_rule_9_3_6
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.6
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging"
    $registryValueName = "LogFilePath"
    $type = "String"
    $desiredValue = '{{ win19cis_public_firewall_log_path }}'

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_6_results.stdout'
  register: rule_9_3_6_results

- name: "9.3.7 | GPO | Ensure 'Windows Firewall: Public: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  when: win19cis_rule_9_3_7
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.7
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  block:
    - name: "9.3.7 | GPO | Ensure 'Windows Firewall: Public: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Apply Settings To Registry."
      when:
        - "'(Skipped)' not in item"
        - win19cis_public_firewall_log_size >= 16384
      ansible.windows.win_shell: |
        $gpoName = "{{ item }}"
        $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging"
        $registryValueName = "LogFileSize"
        $type = "DWORD"
        $desiredValue = {{ win19cis_public_firewall_log_size }}

        # Get the current value of the registry key in the GPO
        $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

        # Check if the current value is equal to the desired value
        if ($currentValue -ne $desiredValue) {
            # If not, set the registry value to the desired value
            Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
            Write-Output "Patched"
        } else {
            Write-Output "No Change Needed"
        }
      loop:
        - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
        - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
      loop_control:
        label: "{{ item }}"
      changed_when: '"Patched" in rule_9_3_7_results.stdout'
      register: rule_9_3_7_results

    - name: "9.3.7 | AUDIT | Ensure 'Windows Firewall: Public: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Warning Check For Variable Standards."
      when: win19cis_public_firewall_log_size < 16384
      ansible.builtin.debug:
        msg:
          - "Warning!! You have an invalid size set for win19cis_public_firewall_log_size please read"
          - "the notes for the variable and make the necessary change to the variable to be in compliance."

    - name: "9.3.7 | AUDIT | Ensure 'Windows Firewall: Public: Logging: Size limit (KB)' is set to '16,384 KB or greater' | Warn Count."
      when: win19cis_public_firewall_log_size < 16384
      ansible.builtin.import_tasks:
        file: warning_facts.yml
      vars:
        warn_control_id: '9.3.7'

- name: "9.3.8 | GPO | Ensure 'Windows Firewall: Public: Logging: Log dropped packets' is set to 'Yes'"
  when:
    - win19cis_rule_9_3_8
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.8
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.3.1
    - NIST800-171_3.3.2
    - NIST800-171_3.3.6
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_AU-3
    - NIST800-53_AU-3_1
    - NIST800-53_AU-7
    - NIST800-53_AU-12
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_AU-3
    - NIST800-53R5_AU-3_1
    - NIST800-53R5_AU-7
    - NIST800-53R5_AU-12
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging"
    $registryValueName = "LogDroppedPackets"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_8_results.stdout'
  register: rule_9_3_8_results

- name: "9.3.9 | GPO | Ensure 'Windows Firewall: Public: Logging: Log successful connections' is set to 'Yes'"
  when:
    - win19cis_rule_9_3_9
    - "'(Skipped)' not in item"
  tags:
    - level1-domaincontroller
    - level1-memberserver
    - rule_9.3.9
    - patch
    - firewall
    - public
    - gpo
    - NIST800-171_3.3.1
    - NIST800-171_3.3.2
    - NIST800-171_3.3.6
    - NIST800-171_3.13.1
    - NIST800-171_3.13.5
    - NIST800-171_3.13.6
    - NIST800-53_AU-3
    - NIST800-53_AU-3_1
    - NIST800-53_AU-7
    - NIST800-53_AU-12
    - NIST800-53_SC-7
    - NIST800-53_SC-7_5
    - NIST800-53R5_AU-3
    - NIST800-53R5_AU-3_1
    - NIST800-53R5_AU-7
    - NIST800-53R5_AU-12
    - NIST800-53R5_SC-7
    - NIST800-53R5_SC-7_5
  ansible.windows.win_shell: |
    $gpoName = "{{ item }}"
    $registryKeyPath = "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging"
    $registryValueName = "LogSuccessfulConnections"
    $type = "DWORD"
    $desiredValue = 1

    # Get the current value of the registry key in the GPO
    $currentValue = (Get-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -ErrorAction SilentlyContinue).Value

    # Check if the current value is equal to the desired value
    if ($currentValue -ne $desiredValue) {
        # If not, set the registry value to the desired value
        Set-GPRegistryValue -Name $gpoName -Key $registryKeyPath -ValueName $registryValueName -Type $type -Value $desiredValue
        Write-Output "Patched"
    } else {
        Write-Output "No Change Needed"
    }
  loop:
    - "{{ win19cis_l1_dc_gpo_name ~ ( '(Skipped)' if not win19cis_l1_dc_gpo else '' ) }}"
    - "{{ win19cis_l1_ms_gpo_name ~ ( '(Skipped)' if not win19cis_l1_ms_gpo else '' ) }}"
  loop_control:
    label: "{{ item }}"
  changed_when: '"Patched" in rule_9_3_9_results.stdout'
  register: rule_9_3_9_results

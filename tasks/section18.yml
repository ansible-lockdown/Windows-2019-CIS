---

- name: "18.1.1.1 | PATCH | Ensure Prevent enabling lock screen camera is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Personalization
      name: NoLockScreenCamera
      data: 1
      type: dword
  when:
      - win19cis_rule_18_1_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.1.1.1
      - patch
      - camera

- name: "18.1.1.2 | PATCH | Ensure Prevent enabling lock screen slide show is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Personalization
      name: NoLockScreenSlideshow
      data: 1
      type: dword
  when:
      - win19cis_rule_18_1_1_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.1.1.2
      - patch
      - lockscreen

- name: "18.1.2.2 | PATCH | Ensure Allow users to enable online speech recognition services is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\InputPersonalization
      name: "AllowInputPersonalization"
      data: "0"
      type: dword
  when:
      - win19cis_rule_18_1_2_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.1.2.2
      - patch
      - onlinespeech

- name: "18.1.3 | PATCH | Ensure Allow Online Tips is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
      name: AllowOnlineTips
      data: 0
      type: dword
  when:
      - win19cis_rule_18_1_3
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.1.3
      - patch
      - onlinetips

- name: "18.2.1 | PATCH | Ensure LAPS AdmPwd GPO Extension  CSE is installed MS only"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions\{D76B9641-3288-4f75-942D-087DE603E3EA}
      name: DllName
      data: C:\Program Files\LAPS\CSE\AdmPwd.dll
      type: string
  when:
      - win19cis_rule_18_2_1
      - ansible_windows_domain_role == "Member Server"
  tags:
      - level1-memberserver
      - rule_18.2.1
      - patch
      - laps
      - gpo

- name: "18.2.2 | PATCH | Ensure Do not allow password expiration time longer than required by policy is set to Enabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
      name: PwdExpirationProtectionEnabled
      data: 1
      type: dword
  when:
      - win19cis_rule_18_2_2
      - ansible_windows_domain_role == "Member Server"
  tags:
      - level1-memberserver
      - rule_18.2.2
      - patch
      - accounts

- name: "18.2.3 | PATCH | Ensure Enable Local Admin Password Management is set to Enabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
      name: AdmPwdEnabled
      data: 1
      type: dword
  when:
      - win19cis_rule_18_2_3
      - ansible_windows_domain_role == "Member Server"
  tags:
      - level1-memberserver
      - rule_18.2.3
      - patch
      - accounts
      - admin

- name: "18.2.4 | PATCH | Ensure Password Settings Password Complexity is set to Enabled Large letters  small letters  numbers  special characters MS only"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
      name: PasswordComplexity
      data: 4
      type: dword
  when:
      - win19cis_rule_18_2_4
      - ansible_windows_domain_role != "Member Server"
  tags:
      - level1-memberserver
      - rule_18.2.4
      - patch
      - accounts

- name: "18.2.5 | PATCH | Ensure Password Settings Password Length is set to Enabled 15 or more MS only"
  block:
      - name: "18.2.5 | AUDIT | Ensure Password Settings Password Length is set to Enabled 15 or more MS only. | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid password length set for win19cis_laps_password_length please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_laps_password_length < 15

      - name: "18.2.5 | AUDIT | Ensure Password Settings Password Length is set to Enabled 15 or more MS only. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.2.5'
        when:
            - win19cis_laps_password_length < 15

      - name: "18.2.5 | PATCH | Ensure Password Settings Password Length is set to Enabled 15 or more MS only. | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
            name: PasswordLength
            data: "{{ win19cis_laps_password_length }}"
            type: dword
        when:
            - win19cis_laps_password_length >= 15
  when:
      - win19cis_rule_18_2_5
      - ansible_windows_domain_role == "Member Server"
  tags:
      - level1-memberserver
      - rule_18.2.5
      - patch
      - accounts

- name: "18.2.6 | PATCH | Ensure Password Settings Password Age Days is set to Enabled 30 or fewer MS only"
  block:
      - name: "18.2.6 | AUDIT | Ensure Password Settings Password Age Days is set to Enabled 30 or fewer MS only | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid password length set for win19cis_laps_password_length please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_laps_password_age_days > 30

      - name: "18.2.6 | AUDIT | Ensure Password Settings Password Age Days is set to Enabled 30 or fewer MS only | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.2.6'
        when:
            - win19cis_laps_password_age_days > 30

      - name: "18.2.6 | PATCH | Ensure Password Settings Password Age Days is set to Enabled 30 or fewer MS only | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
            name: PasswordAgeDays
            data: "{{ win19cis_laps_password_age_days }}"
            type: dword
        when:
            - win19cis_laps_password_age_days <= 30
  when:
      - win19cis_rule_18_2_6
      - ansible_windows_domain_role == "Member Server"
  tags:
      - level1-memberserver
      - rule_18.2.6
      - patch
      - accounts

- name: "18.3.1 | PATCH | Ensure Apply UAC restrictions to local accounts on network logons is set to Enabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
      name: LocalAccountTokenFilterPolicy
      data: 0
      type: dword
  when:
      - win19cis_rule_18_3_1
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level1-memberserver
      - rule_18.3.1
      - patch
      - uac

- name: "18.3.2 | PATCH | Ensure Configure SMB v1 client driver is set to Enabled Disable driver recommended"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10
      name: Start
      data: 4
      type: dword
  when:
      - win19cis_rule_18_3_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.3.2
      - patch
      - smb

- name: "18.3.3 | PATCH | Ensure Configure SMB v1 server is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
      name: SMB1
      data: 0
      type: dword
      state: present
  notify: reboot_windows
  when:
      - win19cis_rule_18_3_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.3.3
      - patch
      - smb

- name: "18.3.4 | PATCH | Ensure Enable Structured Exception Handling Overwrite Protection SEHOP is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\kernel
      name: DisableExceptionChainValidation
      data: 0
      type: dword
      state: present
  when:
      - win19cis_rule_18_3_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.3.4
      - patch
      - sehop

- name: "18.3.5 | PATCH | Ensure Limits print driver installation to Administrators is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
      name: RestrictDriverInstallationToAdministrators
      data: 1
      type: dword
  when:
      - win19cis_rule_18_3_5
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.3.5
      - patch
      - printers
      - drivers

- name: "18.3.6 | PATCH | Ensure 'NetBT NodeType configuration' is set to 'Enabled: P-node recommended'"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\NetBT\Parameters
      state: present
      value: NodeType
      data: "{{ win19cis_netbt_nodetype }}"
      datatype: dword
  when:
      - win19cis_rule_18_3_6
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.3.6
      - patch
      - netbt

- name: "18.3.7 | PATCH | Ensure WDigest Authentication is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest
      state: present
      value: UseLogonCredential
      data: 0
      datatype: dword
  when:
      - win19cis_rule_18_3_7
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.3.7
      - patch
      - wdigest

- name: "18.4.1 | PATCH | Ensure MSS AutoAdminLogon Enable Automatic Logon not recommended is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      state: present
      value: AutoAdminLogon
      data: 0
      datatype: string
  when:
      - win19cis_rule_18_4_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.1
      - patch
      - mss
      - logon

- name: "18.4.2 | PATCH | Ensure MSS DisableIPSourceRouting IPv6 IP source routing protection level protects against packet spoofing is set to Enabled Highest protection source routing is completely disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters
      state: present
      value: DisableIPSourceRouting
      data: 2
      datatype: dword
  when:
      - win19cis_rule_18_4_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.2
      - patch
      - mss
      - iprouting

- name: "18.4.3 | PATCH | Ensure MSS DisableIPSourceRouting IP source routing protection level protects against packet spoofing is set to Enabled Highest protection source routing is completely disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
      state: present
      value: DisableIPSourceRouting
      data: 2
      datatype: dword
  when:
      - win19cis_rule_18_4_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.3
      - patch
      - mss
      - iprouting

- name: "18.4.4 | PATCH | Ensure MSS EnableICMPRedirect Allow ICMP redirects to override OSPF generated routes is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
      state: present
      value: EnableICMPRedirect
      data: 0
      datatype: dword
  when:
      - win19cis_rule_18_4_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.4
      - patch
      - mss
      - icmps

- name: "18.4.5 | PATCH | Ensure MSS KeepAliveTime How often keep-alive packets are sent in milliseconds is set to Enabled 300000 or 5 minutes recommended"
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
      state: present
      value: KeepAliveTime
      data: 300000
      datatype: dword
  when:
      - win19cis_rule_18_4_5
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.4.5
      - patch
      - mss
      - keepalive

- name: "18.4.6 | PATCH | Ensure MSS NoNameReleaseOnDemand Allow the computer to ignore NetBIOS name release requests except from WINS servers is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\System\Currentcontrolset\Services\Netbt\Parameters
      state: present
      name: NoNameReleaseOnDemand
      data: 1
      type: dword
  when:
      - win19cis_rule_18_4_6
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.6
      - patch
      - mss
      - noname

- name: "18.4.7 | PATCH | Ensure MSS PerformRouterDiscovery Allow IRDP to detect and configure Default Gateway addresses could lead to DoS is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\System\Currentcontrolset\Services\Tcpip\Parameters
      state: present
      name: PerformRouterDiscovery
      data: 0
      type: dword
  when:
      - win19cis_rule_18_4_7
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.4.7
      - patch
      - mss

- name: "18.4.8 | PATCH | Ensure MSS SafeDllSearchMode Enable Safe DLL search mode recommended is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\System\Currentcontrolset\Control\Session Manager
      name: SafeDllSearchMode
      data: 1
      type: dword
      state: present
  when:
      - win19cis_rule_18_4_8
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.8
      - patch
      - mss

- name: "18.4.9 | PATCH | Ensure MSS ScreenSaverGracePeriod The time in seconds before the screen saver grace period expires 0 recommended is set to Enabled 5 or fewer seconds"
  block:
      - name: "18.4.9 | AUDIT | Ensure MSS ScreenSaverGracePeriod The time in seconds before the screen saver grace period expires 0 recommended is set to Enabled 5 or fewer seconds | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid time set for win19cis_screen_saver_grace_period please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_screen_saver_grace_period > 5

      - name: "18.4.9 | PATCH | Ensure MSS ScreenSaverGracePeriod The time in seconds before the screen saver grace period expires 0 recommended is set to Enabled 5 or fewer seconds | Set Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.4.9'
        when:
            - win19cis_screen_saver_grace_period > 5

      - name: "18.4.9 | PATCH | Ensure MSS ScreenSaverGracePeriod The time in seconds before the screen saver grace period expires 0 recommended is set to Enabled 5 or fewer seconds | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
            name: ScreenSaverGracePeriod
            data: "{{ win19cis_screen_saver_grace_period }}"
            type: string
            state: present
        when:
            - win19cis_screen_saver_grace_period <= 5
  when:
      - win19cis_rule_18_4_9
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.9
      - patch
      - mss

- name: "18.4.10 | PATCH | Ensure MSS TcpMaxDataRetransmissions IPv6 How many times unacknowledged data is retransmitted is set to Enabled 3"
  ansible.windows.win_regedit:
      path: HKLM:\System\Currentcontrolset\Services\Tcpip6\Parameters
      name: TcpMaxDataRetransmissions
      data: 3
      type: dword
  when:
      - win19cis_rule_18_4_10
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.4.10
      - patch
      - mss

- name: "18.4.11 | PATCH | Ensure MSS TcpMaxDataRetransmissions How many times unacknowledged data is retransmitted is set to Enabled 3"
  ansible.windows.win_regedit:
      path: HKLM:\System\Currentcontrolset\Services\Tcpip\Parameters
      name: TcpMaxDataRetransmissions
      data: 3
      type: dword
  when:
      - win19cis_rule_18_4_11
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.4.11
      - patch
      - mss

- name: "18.4.12 | PATCH | Ensure MSS WarningLevel Percentage threshold for the security event log at which the system will generate a warning is set to Enabled 90 or less"
  block:
      - name: "18.4.12 | AUDIT | Ensure MSS WarningLevel Percentage threshold for the security event log at which the system will generate a warning is set to Enabled 90 or less | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid percentage set for win19cis_log_threshold_audit_event please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_log_threshold_audit_event > 90

      - name: "18.4.12 | AUDIT | Ensure MSS WarningLevel Percentage threshold for the security event log at which the system will generate a warning is set to Enabled 90 or less | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.4.12'
        when:
            - win19cis_log_threshold_audit_event > 90

      - name: "18.4.12 | PATCH | Ensure MSS WarningLevel Percentage threshold for the security event log at which the system will generate a warning is set to Enabled 90 or less | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\System\Currentcontrolset\Services\Eventlog\Security
            name: WarningLevel
            data: "{{ win19cis_log_threshold_audit_event }}"
            type: dword
        when:
            - win19cis_log_threshold_audit_event <= 90
  when:
      - win19cis_rule_18_4_12
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.4.12
      - patch
      - mss

- name: "18.5.4.1 | PATCH | Ensure Configure DNS over HTTPS (DoH) name resolution is set to Enabled: Allow DoH or higher"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient
      name: DoHPolicy
      data: 2
      type: dword
  when:
      - win19cis_rule_18_5_4_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.4.1
      - patch
      - dns

- name: "18.5.4.2 | PATCH | Ensure Turn off multicast name resolution is set to Enabled MS Only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows NT\DNSClient
      name: EnableMulticast
      data: 0
      type: dword
  when:
      - win19cis_rule_18_5_4_2
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.4.2
      - patch
      - dns

- name: "18.5.5.1 | PATCH | Ensure Enable Font Providers is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      name: EnableFontProviders
      data: 0
      type: dword
  when:
      - win19cis_rule_18_5_5_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.5.1
      - patch
      - dns

- name: "18.5.8.1 | PATCH | Ensure Enable insecure guest logons is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Lanmanworkstation
      name: AllowInsecureGuestAuth
      data: 0
      type: dword
  when:
      - win19cis_rule_18_5_8_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.8.1
      - patch
      - fonts

- name: "18.5.9.1 | PATCH | Ensure Turn on Mapper IO LLTDIO driver is set to Disabled"
  block:
      - name: "18.5.9.1 | PATCH | Ensure Turn on Mapper IO LLTDIO driver is set to Disabled | AllowLLTDIOOndomain"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: AllowLLTDIOOndomain
            data: 0
            type: dword

      - name: "18.5.9.1 | PATCH | Ensure Turn on Mapper IO LLTDIO driver is set to Disabled | AllowLLTDIOOnPublicNet"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: AllowLLTDIOOnPublicNet
            data: 0
            type: dword

      - name: "18.5.9.1 | PATCH | Ensure Turn on Mapper IO LLTDIO driver is set to Disabled | EnableLLTDIO"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: EnableLLTDIO
            data: 0
            type: dword

      - name: "18.5.9.1 | PATCH | Ensure Turn on Mapper IO LLTDIO driver is set to Disabled | ProhibitLLTDIOOnPrivateNet"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: ProhibitLLTDIOOnPrivateNet
            data: 0
            type: dword
  when:
      - win19cis_rule_18_5_9_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.9.1
      - patch
      - mapper
      - drivers

- name: "18.5.9.2 | PATCH | Ensure Turn on Responder RSPNDR driver is set to Disabled"
  block:
      - name: "18.5.9.2 | PATCH | Ensure Turn on Responder RSPNDR driver is set to Disabled | AllowRspndrOnDomain"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: AllowRspndrOnDomain
            data: 0
            type: dword

      - name: "18.5.9.2 | PATCH | Ensure Turn on Responder RSPNDR driver is set to Disabled | AllowRspndrOnPublicNet"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: AllowRspndrOnPublicNet
            data: 0
            type: dword

      - name: "18.5.9.2 | PATCH | Ensure Turn on Responder RSPNDR driver is set to Disabled | EnableRspndr"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: EnableRspndr
            data: 0
            type: dword

      - name: "18.5.9.2 | PATCH | Ensure Turn on Responder RSPNDR driver is set to Disabled | ProhibitRspndrOnPrivateNet"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Lltd
            name: ProhibitRspndrOnPrivateNet
            data: 0
            type: dword
  when:
      - win19cis_rule_18_5_9_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.9.2
      - patch
      - rspndr
      - driver

- name: "18.5.10.2 | PATCH | Ensure Turn off Microsoft Peer-to-Peer Networking Services is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Peernet
      name: Disabled
      data: 1
      type: dword
  when:
      - win19cis_rule_18_5_10_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.10.2
      - patch
      - p2p

- name: "18.5.11.2 | PATCH | Ensure Prohibit installation and configuration of Network Bridge on your DNS domain network is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Network Connections
      name: NC_AllowNetBridge_NLA
      data: 0
      type: dword
  when:
      - win19cis_rule_18_5_11_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.11.2
      - patch
      - networkconnections

- name: "18.5.11.3 | PATCH | Ensure Prohibit use of Internet Connection Sharing on your DNS domain network is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Network Connections
      name: NC_ShowSharedAccessUI
      data: 0
      type: dword
  when:
      - win19cis_rule_18_5_11_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.11.3
      - patch
      - networkconnections

- name: "18.5.11.4 | PATCH | Ensure Require domain users to elevate when setting a networks location is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Network Connections
      name: NC_StdDomainUserSetLocation
      data: 1
      type: dword
  when:
      - win19cis_rule_18_5_11_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.11.4
      - patch
      - networkconnections

- name: "18.5.14.1 | PATCH | Ensure Hardened UNC Paths is set to Enabled with Require Mutual Authentication and Require Integrity set for all NETLOGON and SYSVOL shares"
  block:
      - name: "18.5.14.1 | PATCH | Ensure Hardened UNC Paths is set to Enabled with Require Mutual Authentication and Require Integrity set for all NETLOGON shares"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Networkprovider\Hardenedpaths
            name: "\\\\*\\NETLOGON"
            data: "RequireMutualAuthentication=1, RequireIntegrity=1"
            type: string

      - name: "18.5.14.1 | PATCH | Ensure Hardened UNC Paths is set to Enabled with Require Mutual Authentication and Require Integrity set for all SYSVOL shares"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Networkprovider\Hardenedpaths
            name: "\\\\*\\SYSVOL"
            data: "RequireMutualAuthentication=1, RequireIntegrity=1"
            type: string
  when:
      - win19cis_rule_18_5_14_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.14.1
      - patch
      - paths
      - unc

- name: "18.5.19.2.1 | PATCH | Disable IPv6 Ensure TCPIP6 Parameter DisabledComponents is set to 0xff 255"
  ansible.windows.win_regedit:
      path: HKLM:\System\CurrentControlSet\Services\TCPIP6\Parameters
      name: DisabledComponents
      data: 255
      type: dword
  when:
      - win19cis_rule_18_5_19_2_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.19.2.1
      - patch
      - ipv6

- name: "18.5.20.1 | PATCH | Ensure Configuration of wireless settings using Windows Connect Now is set to Disabled"
  block:
      - name: "18.5.20.1 | PATCH | Ensure Configuration of wireless settings using Windows Connect Now is set to Disabled | EnableRegistrars"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Wcn\Registrars
            name: EnableRegistrars
            data: 0
            type: dword

      - name: "18.5.20.1 | PATCH | Ensure Configuration of wireless settings using Windows Connect Now is set to Disabled | DisableUPnPRegistrar"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Wcn\Registrars
            name: DisableUPnPRegistrar
            data: 0
            type: dword

      - name: "18.5.20.1 | PATCH | Ensure Configuration of wireless settings using Windows Connect Now is set to Disabled | DisableInBand802DOT11Registrar"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Wcn\Registrars
            name: DisableInBand802DOT11Registrar
            data: 0
            type: dword

      - name: "18.5.20.1 | PATCH | Ensure Configuration of wireless settings using Windows Connect Now is set to Disabled | DisableFlashConfigRegistrar"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Wcn\Registrars
            name: DisableFlashConfigRegistrar
            data: 0
            type: dword

      - name: "18.5.20.1 | PATCH | Ensure Configuration of wireless settings using Windows Connect Now is set to Disabled | DisableWPDRegistrar"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Wcn\Registrars
            name: DisableWPDRegistrar
            data: 0
            type: dword
  when:
      - win19cis_rule_18_5_20_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.20.1
      - patch
      - wireless

- name: "18.5.20.2 | PATCH | Ensure Prohibit access of the Windows Connect Now wizards is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Wcn\Ui
      name: DisableWcnUi
      data: 1
      type: dword
  when:
      - win19cis_rule_18_5_20_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.5.20.2
      - patch
      - connectnow

- name: "18.5.21.1 | PATCH | Ensure Minimize the number of simultaneous connections to the Internet or a Windows Domain is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Wcmsvc\Grouppolicy
      name: fMinimizeConnections
      data: 3
      type: dword
  when:
      - win19cis_rule_18_5_21_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.5.21.1
      - patch
      - gpo

- name: "18.5.21.2 | PATCH | Ensure Prohibit connection to non-domain networks when connected to domain authenticated network is set to Enabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Wcmsvc\Grouppolicy
      name: fBlockNonDomain
      data: 1
      type: dword
  when:
      - win19cis_rule_18_5_21_2
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level2-memberserver
      - rule_18.5.21.2
      - patch
      - gpo

- name: "18.6.1 | PATCH | Ensure Allow Print Spooler to accept client connections is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows NT\Printers
      name: RegisterSpoolerRemoteRpcEndPoint
      data: 2
      type: dword
  when:
      - win19cis_rule_18_6_1
  tags:
      - level1-domaincontroller
      - level2-memberserver
      - rule_18.6.1
      - patch
      - printers

- name: "18.6.2 | PATCH | Ensure Point and Print Restrictions: When installing drivers for a new connection is set to Enabled: Show warning and elevation prompt"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint
      name: NoWarningNoElevationOnInstall
      data: 0
      type: dword
  when:
      - win19cis_rule_18_6_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.6.2
      - patch
      - printers

- name: "18.6.3 | PATCH | Ensure Point and Print Restrictions: When updating drivers for an existing connection is set to Enabled: Show warning and elevation prompt"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint
      name: UpdatePromptSettings
      data: 0
      type: dword
  when:
      - win19cis_rule_18_6_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.6.3
      - patch
      - printers

- name: "18.7.1.1 | PATCH | Ensure Turn off notifications network usage is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\PushNotifications
      name: NoCloudApplicationNotification
      data: 1
      type: dword
  when:
      - win19cis_rule_18_7_1_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.7.1.1
      - patch
      - notifications

- name: "18.8.3.1 | PATCH | Ensure Include command line in process creation events is set to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System\Audit
      name: ProcessCreationIncludeCmdLine_Enabled
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_3_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.3.1
      - patch

- name: "18.8.4.1 | PATCH | Ensure Encryption Oracle Remediation is set to Enabled Force Updated Clients"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters
      name: AllowEncryptionOracle
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_4_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.4.1
      - patch
      - encryption_oracle

- name: "18.8.4.2 | PATCH | Ensure Remote host allows delegation of non-exportable credentials is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation
      name: AllowProtectedCreds
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_4_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.4.2
      - patch
      - credentialsdelecation

- name: "18.8.5.1 | PATCH | NG Ensure Turn On Virtualization Based Security is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: EnableVirtualizationBasedSecurity
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_5_1
  tags:
      - ngws-domaincontroller
      - ngws-memberserver
      - rule_18.8.5.1
      - patch
      - vbs

- name: "18.8.5.2 | PATCH | NG Ensure Turn On Virtualization Based Security Select Platform Security Level is set to Secure Boot and DMA Protection"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: RequirePlatformSecurityFeatures
      data: 3
      type: dword
  when:
      - win19cis_rule_18_8_5_2
  tags:
      - ngws-domaincontroller
      - ngws-memberserver
      - rule_18.8.5.2
      - patch
      - vbs

- name: "18.8.5.3 | PATCH | NG Ensure Turn On Virtualization Based Security Virtualization Based Protection of Code Integrity is set to Enabled with UEFI lock"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: HypervisorEnforcedCodeIntegrity
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_5_3
  tags:
      - ngws-domaincontroller
      - ngws-memberserver
      - rule_18.8.5.3
      - patch
      - vbs

- name: "18.8.5.4 | PATCH | NG Ensure Turn On Virtualization Based Security Require UEFI Memory Attributes Table is set to True checked"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: HVCIMATRequired
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_5_4
  tags:
      - ngws-domaincontroller
      - ngws-memberserver
      - rule_18.8.5.4
      - patch
      - vbs

- name: "18.8.5.5 | PATCH | NG Ensure Turn On Virtualization Based Security Credential Guard Configuration is set to Enabled with UEFI lock MS Only"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: LsaCfgFlags
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_5_5
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - ngws-memberserver
      - rule_18.8.5.5
      - patch
      - vbs

- name: "18.8.5.6 | PATCH | NG Ensure Turn On Virtualization Based Security Credential Guard Configuration is set to Disabled DC Only"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: LsaCfgFlags
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_5_6
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - ngws-domaincontroller
      - rule_18.8.5.6
      - patch
      - vbs

- name: "18.8.5.7 | PATCH | NG Ensure Turn On Virtualization Based Security Secure Launch Configuration is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
      name: ConfigureSystemGuardLaunch
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_5_7
  tags:
      - ngws-domaincontroller
      - ngws-memberserver
      - rule_18.8.5.7
      - patch
      - vbs

- name: "18.8.7.2 | PATCH | Ensure Prevent device metadata retrieval from the Internet is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Device Metadata
      name: PreventDeviceMetadataFromNetwork
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_7_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.7.2
      - patch
      - metadata

- name: "18.8.14.1 | PATCH | Ensure Boot-Start Driver Initialization Policy is set to Enabled Good unknown and bad but critical"
  ansible.windows.win_regedit:
      path: HKLM:\System\Currentcontrolset\Policies\Earlylaunch
      name: DriverLoadPolicy
      data: 3
      type: dword
  when:
      - win19cis_rule_18_8_14_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.14.1
      - patch
      - drivers

- name: "18.8.21.2 | PATCH | Ensure Configure registry policy processing Do not apply during periodic background processing is set to Enabled FALSE"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378Eac-683F-11D2-A89A-00C04Fbbcfa2}
      name: NoBackgroundPolicy
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_21_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.21.2
      - patch
      - gpo

- name: "18.8.21.3 | PATCH | Ensure Configure registry policy processing Process even if the Group Policy objects have not changed is set to Enabled TRUE"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378Eac-683F-11D2-A89A-00C04Fbbcfa2}
      name: NoGPOListChanges
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_21_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.21.3
      - patch
      - gpo

- name: "18.8.21.4 | PATCH | Ensure Continue experiences on this device is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      name: EnableCdp
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_21_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.21.4
      - patch

- name: "18.8.21.5 | PATCH | Ensure Turn off background refresh of Group Policy is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System\DisableBkGndGroupPolicy
      name: DisableBkGndGroupPolicy
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_21_5
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.21.5
      - patch
      - gpo

- name: "18.8.22.1.1 | PATCH | Ensure Turn off downloading of print drivers over HTTP is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Printers
      name: DisableWebPnPDownload
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.22.1.1
      - patch
      - drivers
      - printers

- name: "18.8.22.1.2 | PATCH | Ensure Turn off handwriting personalization data sharing is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Tabletpc
      name: PreventHandwritingDataSharing
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.2
      - patch
      - handwriting

- name: "18.8.22.1.3 | PATCH | Ensure Turn off handwriting recognition error reporting is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Handwritingerrorreports
      name: PreventHandwritingErrorReports
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_3
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.3
      - patch
      - handwriting

- name: "18.8.22.1.4 | PATCH | Ensure Turn off Internet Connection Wizard if URL connection is referring to Microsoft.com is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Internet Connection Wizard
      name: ExitOnMSICW
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_4
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.4
      - patch
      - wizard
      - internetconnectionwizard

- name: "18.8.22.1.5 | PATCH | Ensure Turn off Internet download for Web publishing and online ordering wizards is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
      name: NoWebServices
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_5
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.22.1.5
      - patch
      - wizard
      - internetdownloadwizard

- name: "18.8.22.1.6 | PATCH | Ensure Turn off printing over HTTP is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Printers
      name: DisableHTTPPrinting
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_6
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.6
      - patch
      - printers

- name: "18.8.22.1.7 | PATCH | Ensure Turn off Registration if URL connection is referring to Microsoft.com is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Registration Wizard Control
      name: NoRegistration
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_7
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.7
      - patch
      - wizard
      - registration

- name: "18.8.22.1.8 | PATCH | Ensure Turn off Search Companion content file updates is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Searchcompanion
      name: DisableContentFileUpdates
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_8
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.8
      - patch
      - search

- name: "18.8.22.1.9 | PATCH | Ensure Turn off the Order Prints picture task is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
      name: NoOnlinePrintsWizard
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_9
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.9
      - patch
      - printers

- name: "18.8.22.1.10 | PATCH | Ensure Turn off the Publish to Web task for files and folders is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
      name: NoPublishingWizard
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_22_1_10
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.10
      - patch
      - wizard

- name: "18.8.22.1.11 | PATCH | Ensure Turn off the Windows Messenger Customer Experience Improvement Program is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Messenger\Client
      name: CEIP
      data: 2
      type: dword
  when:
      - win19cis_rule_18_8_22_1_11
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.11
      - patch
      - wmcei

- name: "18.8.22.1.12 | PATCH | Ensure Turn off Windows Customer Experience Improvement Program is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Sqmclient\Windows
      name: CEIPEnable
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_22_1_12
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.12
      - patch
      - wmcei

- name: "18.8.22.1.13 | PATCH | Ensure Turn off Windows Error Reporting is set to Enabled"
  block:
      - name: "18.8.22.1.13 | PATCH | Ensure Turn off Windows Error Reporting is set to Enabled | Windows Error Reporting"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Windows Error Reporting
            name: Disabled
            data: 1
            type: dword

      - name: "18.8.22.1.13 | PATCH | Ensure Turn off Windows Error Reporting is set to Enabled | ErrorReporting"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\PCHealth\ErrorReporting
            name: DoReport
            data: 0
            type: dword
  when:
      - win19cis_rule_18_8_22_1_13
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.22.1.13
      - patch
      - errorreporting

- name: "18.8.25.1 | PATCH | Ensure Support device authentication using certificate is set to Enabled Automatic"
  block:
      - name: "18.8.25.1 | PATCH | Ensure Support device authentication using certificate is set to Enabled Automatic | DevicePKInitBehavior"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\kerberos\parameters
            name: DevicePKInitBehavior
            data: 0
            type: dword

      - name: "18.8.25.1 | PATCH | Ensure Support device authentication using certificate is set to Enabled Automatic | DevicePKInitEnabled"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\kerberos\parameters
            name: DevicePKInitEnabled
            data: 1
            type: dword
  when:
      - win19cis_rule_18_8_25_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.25.1
      - patch
      - certifcates

- name: "18.8.26.1 | PATCH | Ensure Enumeration policy for external devices incompatible with Kernel DMA Protection is set to Enabled Block All"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Kernel DMA Protection
      name: DeviceEnumerationPolicy
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_26_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.26.1
      - patch
      - dma

- name: "18.8.27.1 | PATCH | Ensure Disallow copying of user input methods to the system account for sign-in is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Control Panel\International
      name: BlockUserInputMethodsForSignIn
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_27_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.27.1
      - patch

- name: "18.8.28.1 | PATCH | Ensure Block user from showing account details on sign-in is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: BlockUserFromShowingAccountDetailsOnSignin
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_28_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.28.1
      - patch
      - accounts

- name: "18.8.28.2 | PATCH | Ensure Do not display network selection UI is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: DontDisplayNetworkSelectionUI
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_28_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.28.2
      - patch

- name: "18.8.28.3 | PATCH | Ensure Do not enumerate connected users on domain-joined computers is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: DontEnumerateConnectedUsers
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_28_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.28.3
      - patch
      - enumerate

- name: "18.8.28.4 | PATCH | Ensure Enumerate local users on domain-joined computers is set to Disabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: EnumerateLocalUsers
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_28_4
  tags:
      - level1-memberserver
      - rule_18.8.28.4
      - patch
      - enumerate

- name: "18.8.28.5 | PATCH | Ensure Turn off app notifications on the lock screen is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: DisableLockScreenAppNotifications
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_28_5
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.28.5
      - patch
      - notifications

- name: "18.8.28.6 | PATCH | Ensure Turn off picture password sign-in is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: BlockDomainPicturePassword
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_28_6
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.28.6
      - patch
      - logon

- name: "18.8.28.7 | PATCH | Ensure Turn on convenience PIN sign-in is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: AllowDomainPINLogon
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_28_7
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.28.7
      - patch
      - pin

- name: "18.8.31.1 | PATCH | Ensure Allow Clipboard synchronization across devices is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: AllowCrossDeviceClipboard
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_31_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.31.1
      - patch
      - clipboard

- name: "18.8.31.2 | PATCH | Ensure Allow upload of User Activities is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\System
      name: UploadUserActivities
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_31_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.31.2
      - patch

- name: "18.8.34.6.1 | PATCH | Ensure Allow network connectivity during connected-standby on battery is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\f15576e8-98b7-4186-b944-eafa664402d9
      name: DCSettingIndex
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_34_6_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.34.6.1
      - patch
      - power

- name: "18.8.34.6.2 | PATCH | Ensure Allow network connectivity during connected-standby plugged in is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\f15576e8-98b7-4186-b944-eafa664402d9
      name: ACSettingIndex
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_34_6_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.34.6.2
      - patch
      - power

- name: "18.8.34.6.3 | PATCH | Ensure Require a password when a computer wakes on battery is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      name: DCSettingIndex
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_34_6_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.34.6.3
      - patch
      - power
      - logon

- name: "18.8.34.6.4 | PATCH | Ensure Require a password when a computer wakes plugged in is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      name: ACSettingIndex
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_34_6_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.34.6.4
      - patch
      - logon

- name: "18.8.36.1 | PATCH | Ensure Configure Offer Remote Assistance is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fAllowUnsolicited
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_36_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.36.1
      - patch
      - cora

- name: "18.8.36.2 | PATCH | Ensure Configure Solicited Remote Assistance is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fAllowToGetHelp
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_36_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.8.36.2
      - patch
      - csra

- name: "18.8.37.1 | PATCH | Ensure Enable RPC Endpoint Mapper Client Authentication is set to Enabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Rpc
      name: EnableAuthEpResolution
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_37_1
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level1-memberserver
      - rule_18.8.37.1
      - patch
      - rpc

- name: "18.8.37.2 | PATCH | Ensure Restrict Unauthenticated RPC clients is set to Enabled Authenticated MS only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Rpc
      name: RestrictRemoteClients
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_37_2
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level2-memberserver
      - rule_18.8.37.2
      - patch
      - rpc

- name: "18.8.40.1 | PATCH | Ensure Configure validation of ROCA-vulnerable WHfB keys during authentication is set to Enabled: Audit or higher"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\SAM
      name: SamNGCKeyROCAValidation
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_40_1
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level1-domaincontroller
      - rule_18.8.40.1
      - patch
      - sam

- name: "18.8.48.5.1 | PATCH | Ensure Microsoft Support Diagnostic Tool Turn on MSDT interactive communication with support provider is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Scripteddiagnosticsprovider\Policy
      name: DisableQueryRemoteServer
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_48_5_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.48.5.1
      - patch
      - msdt

- name: "18.8.48.11.1 | PATCH | Ensure EnableDisable PerfTrack is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Wdi\{9C5A40Da-B965-4Fc3-8781-88Dd50A6299D}
      name: ScenarioExecutionEnabled
      data: 0
      type: dword
  when:
      - win19cis_rule_18_8_48_11_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.48.11.1
      - patch
      - pertrack

- name: "18.8.50.1 | PATCH | Ensure Turn off the advertising ID is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Advertisinginfo
      name: DisabledByGroupPolicy
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_50_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.50.1
      - patch
      - advertising

- name: "18.8.53.1.1 | PATCH | Ensure Enable Windows NTP Client is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\W32Time\Timeproviders\Ntpclient
      name: Enabled
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_53_1_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.8.53.1.1
      - patch
      - ntp

- name: "18.8.53.1.2 | PATCH | Ensure Enable Windows NTP Server is set to Disabled MS only"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\W32Time\Timeproviders\Ntpserver
      name: Enabled
      data: 1
      type: dword
  when:
      - win19cis_rule_18_8_53_1_2
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - level2-memberserver
      - rule_18.8.53.1.2
      - patch
      - ntp

- name: "18.9.4.1 | PATCH | Ensure Allow a Windows app to share application data between users is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Currentversion\Appmodel\Statemanager
      name: AllowSharedLocalAppData
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_4_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.4.1
      - patch
      - data

- name: "18.9.6.1 | PATCH | Ensure Allow Microsoft accounts to be optional is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
      name: MSAOptional
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_6_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.6.1
      - patch
      - accounts

- name: "18.9.8.1 | PATCH | Ensure Disallow Autoplay for non-volume devices is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
      name: NoAutoplayfornonVolume
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_8_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.8.1
      - patch
      - autoplay

- name: "18.9.8.2 | PATCH | Ensure Set the default behavior for AutoRun is set to Enabled Do not execute any autorun commands"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
      name: NoAutorun
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_8_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.8.2
      - patch
      - autorun

- name: "18.9.8.3 | PATCH | Ensure Turn off Autoplay is set to Enabled All drives"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
      name: NoDriveTypeAutoRun
      data: 255
      type: dword
  when:
      - win19cis_rule_18_9_8_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.8.3
      - patch
      - autoplay

- name: "18.9.10.1.1 | PATCH | Ensure Configure enhanced anti-spoofing is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Biometrics\Facialfeatures
      name: EnhancedAntiSpoofing
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_10_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.10.1.1
      - patch
      - antispoofing

- name: "18.9.12.1 | PATCH | Ensure Allow Use of Camera is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Camera
      name: AllowCamera
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_12_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.12.1
      - patch
      - camera

- name: "18.9.14.1 | PATCH | Ensure Turn off cloud consumer account state content is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\CloudContent
      name: DisableConsumerAccountStateContent
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_14_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.14.1
      - patch
      - cloud

- name: "18.9.14.2 | PATCH | Ensure Turn off Microsoft consumer experiences is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Cloudcontent
      name: DisableWindowsConsumerFeatures
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_14_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.14.2
      - patch
      - cloud

- name: "18.9.15.1 | PATCH | Ensure Require pin for pairing is set to Enabled First Time OR Enabled Always"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Connect
      name: RequirePinForPairing
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_15_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.15.1
      - patch
      - pin

- name: "18.9.16.1 | PATCH | Ensure Do not display the password reveal button is set to Enabled"
  win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Credui
      name: DisablePasswordReveal
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_16_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.16.1
      - patch
      - gui

- name: "18.9.16.2 | PATCH | Ensure Enumerate administrator accounts on elevation is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Credui
      name: EnumerateAdministrators
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_16_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.16.2
      - patch
      - accounts

- name: "18.9.17.1 | PATCH | Ensure Allow Diagnostic Data is set to Enabled: Diagnostic data off (not recommended) or Enabled: Send required diagnostic data"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      name: AllowTelemetry
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.1
      - patch
      - diagnostrics

- name: "18.9.17.2 | PATCH | Ensure Configure Authenticated Proxy usage for the Connected User Experience and Telemetry service is set to Enabled Disable Authenticated Proxy usage"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\DataCollection
      name: DisableEnterpriseAuthProxy
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.17.2
      - patch
      - datacollection

- name: "18.9.17.3 | PATCH | Ensure Disable OneSettings Downloads is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      name: DisableOneSettingsDownloads
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.3
      - patch
      - onesettings

- name: "18.9.17.4 | PATCH | Ensure Do not show feedback notifications is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Datacollection
      name: DoNotShowFeedbackNotifications
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.4
      - patch
      - datacollection

- name: "18.9.17.5 | PATCH | Ensure Enable OneSettings Auditing' is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      name: EnableOneSettingsAuditing
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_5
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.5
      - patch
      - datacollection

- name: "18.9.17.6 | PATCH | Ensure Limit Diagnostic Log Collection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      name: LimitDiagnosticLogCollection
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_6
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.6
      - patch
      - datacollection

- name: "18.9.17.7 | PATCH | Ensure Limit Dump Collection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      name: LimitDumpCollection
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_17_7
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.7
      - patch
      - datacollection

- name: "18.9.17.8 | PATCH | Ensure Toggle user control over Insider builds is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Previewbuilds
      name: AllowBuildPreview
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_17_8
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.17.8
      - patch

- name: "18.9.27.1.1 | PATCH | Ensure Application Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\EventLog\Application
      name: Retention
      data: 0
      type: string
  when:
      - win19cis_rule_18_9_27_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.1.1
      - patch
      - eventlog

- name: "18.9.27.1.2 | PATCH | Ensure Application Specify the maximum log file size KB is set to Enabled 32768 or greater"
  block:
      - name: "18.9.27.1.2 | AUDIT | Ensure Application Specify the maximum log file size KB is set to Enabled 32768 or greater | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for win19cis_application_max_log_file_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_application_max_log_file_size < 32768

      - name: "18.9.27.1.2 | AUDIT | Ensure Application Specify the maximum log file size KB is set to Enabled 32768 or greater | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.9.27.1.2'
        when:
            - win19cis_application_max_log_file_size < 32768

      - name: "18.9.27.1.2 | PATCH | Ensure Application Specify the maximum log file size KB is set to Enabled 32768 or greater | Set File Size."
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Application
            name: MaxSize
            data: "{{ win19cis_application_max_log_file_size }}"
            type: dword
        when:
            - win19cis_application_max_log_file_size >= 32768
  when:
      - win19cis_rule_18_9_27_1_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.1.2
      - patch
      - eventlog

- name: "18.9.27.2.1 | PATCH | Ensure Security Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Security
      name: Retention
      data: 0
      type: string
  when:
      - win19cis_rule_18_9_27_2_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.2.1
      - patch
      - eventlog

- name: "18.9.27.2.2 | PATCH | Ensure Security Specify the maximum log file size KB is set to Enabled 196608 or greater"
  block:
      - name: "18.9.27.2.2 | AUDIT | Ensure Security Specify the maximum log file size KB is set to Enabled 196608 or greater | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for win19cis_security_max_log_file_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_security_max_log_file_size < 196608

      - name: "18.9.27.2.2 | AUDIT | Ensure Security Specify the maximum log file size KB is set to Enabled 196608 or greater | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.9.27.2.2'
        when:
            - win19cis_security_max_log_file_size < 196608

      - name: "18.9.27.2.2 | PATCH | Ensure Security Specify the maximum log file size KB is set to Enabled 196608 or greater | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Security
            name: MaxSize
            data: "{{ win19cis_security_max_log_file_size }}"
            type: dword
        when:
            - win19cis_security_max_log_file_size >= 196608
  when:
      - win19cis_rule_18_9_27_2_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.2.2
      - patch
      - eventlog

- name: "18.9.27.3.1 | PATCH | Ensure Setup Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Setup
      name: Retention
      data: 0
      type: string
  when:
      - win19cis_rule_18_9_27_3_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.3.1
      - patch
      - eventlog

- name: "18.9.27.3.2 | PATCH | Ensure Setup Specify the maximum log file size KB is set to Enabled 32768 or greater"
  block:
      - name: "18.9.27.3.2 | AUDIT | Ensure Setup Specify the maximum log file size KB is set to Enabled 32768 or greater | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for win19cis_setup_max_log_file_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_setup_max_log_file_size < 32768

      - name: "18.9.27.3.2 | AUDIT | Ensure Setup Specify the maximum log file size KB is set to Enabled 32768 or greater | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.9.27.3.2'
        when:
            - win19cis_setup_max_log_file_size < 32768

      - name: "18.9.27.3.2 | PATCH | Ensure Setup Specify the maximum log file size KB is set to Enabled 32768 or greater | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Setup
            name: MaxSize
            data: "{{ win19cis_setup_max_log_file_size }}"
            type: dword
        when:
            - win19cis_setup_max_log_file_size >= 32768
  when:
      - win19cis_rule_18_9_27_3_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.3.2
      - patch
      - eventlog

- name: "18.9.27.4.1 | PATCH | Ensure System Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\System
      name: Retention
      data: 0
      type: string
  when:
      - win19cis_rule_18_9_27_4_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.4.1
      - patch
      - eventlog

- name: "18.9.27.4.2 | PATCH | Ensure System Specify the maximum log file size KB is set to Enabled 32768 or greater"
  block:
      - name: "18.9.27.4.2 | AUDIT | Ensure System Specify the maximum log file size KB is set to Enabled 32768 or greater | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for win19cis_system_max_log_file_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_system_max_log_file_size < 32768

      - name: "18.9.27.4.2 | AUDIT | Ensure System Specify the maximum log file size KB is set to Enabled 32768 or greater | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.9.27.4.2'
        when:
            - win19cis_system_max_log_file_size < 32768

      - name: "18.9.27.4.2 | PATCH | Ensure System Specify the maximum log file size KB is set to Enabled 32768 or greater | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\System
            name: MaxSize
            data: "{{ win19cis_system_max_log_file_size }}"
            type: dword
        when:
            - win19cis_system_max_log_file_size >= 32768
  when:
      - win19cis_rule_18_9_27_4_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.27.4.2
      - patch
      - eventlog

- name: "18.9.31.2 | PATCH | Ensure Turn off Data Execution Prevention for Explorer is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
      name: NoDataExecutionPrevention
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_31_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.31.2
      - patch
      - dep

- name: "18.9.31.3 | PATCH | Ensure Turn off heap termination on corruption is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
      name: NoHeapTerminationOnCorruption
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_31_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.31.3
      - patch
      - heap

- name: "18.9.31.4 | PATCH | Ensure Turn off shell protocol protected mode is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
      name: PreXPSP2ShellProtocolBehavior
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_31_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.31.4
      - patch
      - shell

- name: "18.9.41.1 | PATCH | Ensure Turn off location is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Locationandsensors
      name: DisableLocation
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_41_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.41.1
      - patch
      - location

- name: "18.9.45.1 | PATCH | Ensure Allow Message Service Cloud Sync is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Messaging
      name: AllowMessageSync
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_45_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.45.1
      - patch
      - msc

- name: "18.9.46.1 | PATCH | Ensure Block all consumer Microsoft account user authentication is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\MicrosoftAccount
      name: DisableUserAuth
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_46_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.46.1
      - patch
      - account

- name: "18.9.47.4.1 | PATCH | Ensure Configure local setting override for reporting to Microsoft MAPS is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet
      name: LocalSettingOverrideSpynetReporting
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_4_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.4.1
      - patch
      - maps

- name: "18.9.47.4.2 | PATCH | Ensure Join Microsoft MAPS is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet
      name: SpynetReporting
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_4_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.47.4.2
      - patch
      - maps

- name: "18.9.47.5.1.1  | PATCH | Ensure Configure Attack Surface Reduction rules is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\ASR
      name: ExploitGuard_ASR_Rules
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_47_5_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.5.1.1
      - patch
      - defender

- name: "18.9.47.5.1.2 | PATCH | Ensure Configure Attack Surface Reduction rules Set the state for each ASR rule is configured"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\ASR\Rules
      name: "{{ item }}"
      data: 1
      type: string
  loop:
      - 26190899-1602-49e8-8b27-eb1d0a1ce869
      - 3b576869-a4ec-4529-8536-b80a7769e899
      - 5beb7efe-fd9a-4556-801d-275e5ffc04cc
      - 75668c1f-73b5-4cf0-bb93-3ecf5cb7cc84
      - 7674ba52-37eb-4a4f-a9a1-f0f9a1619a2c
      - 92e97fa1-2edf-4476-bdd6-9dd0b4dddc7b
      - 9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2
      - b2b3f03d-6a65-4f7b-a9c7-1c7ef74a9ba4
      - be9ba2d9-53ea-4cdc-84e5-9b1eeee46550
      - d3e037e1-3eb8-44c8-a917-57927947596d
      - d4f940ab-401b-4efc-aadc-ad5f3c50688a
      - e6db77e5-3df2-4cf1-b95a-636979351e5b
  when:
      - win19cis_rule_18_9_47_5_1_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.5.1.2
      - patch
      - defender

- name: "18.9.47.5.3.1 | PATCH | Ensure Prevent users and apps from accessing dangerous websites is set to Enabled Block"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection
      name: EnableNetworkProtection
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_47_5_3_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.5.3.1
      - patch
      - defender

- name: "18.9.47.6.1 | PATCH | (L2) Ensure 'Enable file hash computation feature' is set to 'Enabled'"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\MpEngine
      name: EnableFileHashComputation
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_47_6_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.47.6.1
      - patch
      - defender

- name: "18.9.47.9.1 | PATCH | Ensure Scan all downloaded files and attachments is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection
      name: DisableIOAVProtection
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_9_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.9.1
      - patch
      - defender
      - real_time_protection

- name: "18.9.47.9.2 | PATCH | Ensure 'Turn off real-time protection' is set to 'Disabled'"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection
      name: DisableRealtimeMonitoring
      data: 1
      datatype: dword
  when:
      - win19cis_rule_18_9_47_9_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.9.2
      - patch
      - defender
      - real_time_protection

- name: "18.9.47.9.3 | PATCH | Ensure Turn on behavior monitoring is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Real-Time Protection
      name: DisableBehaviorMonitoring
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_9_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.9.3
      - patch
      - defender
      - real_time_protection

- name: "18.9.47.9.4 | PATCH | Ensure 'Turn on script scanning' is set to 'Enabled'"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection
      name: DisableScriptScanning
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_9_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.9.4
      - patch
      - defender
      - real_time_protection

- name: "18.9.47.11.1 | PATCH | Ensure Configure Watson events is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Reporting
      name: DisableGenericRePorts
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_47_11_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.47.11.1
      - patch
      - defender

- name: "18.9.47.12.1 | PATCH | Ensure Scan removable drives is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Scan
      name: DisableRemovableDriveScanning
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_12_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.12.1
      - patch
      - defender

- name: "18.9.47.12.2 | PATCH | Ensure Turn on e-mail scanning is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender\Scan
      name: DisableEmailScanning
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_12_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.12.2
      - patch
      - defender

- name: "18.9.47.15 | PATCH | Ensure Configure detection for potentially unwanted applications is set to Enabled Block"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender
      name: PUAProtection
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_47_15
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.15
      - patch
      - defender

- name: "18.9.47.16 | PATCH | Ensure Turn off Windows Defender AntiVirus is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender
      name: DisableAntiSpyware
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_47_16
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.47.16
      - patch
      - defender

- name: "18.9.58.1 | PATCH | Ensure Prevent the usage of OneDrive for file storage is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Onedrive
      name: DisableFileSyncNGSC
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_58_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.58.1
      - patch
      - onedrive

- name: "18.9.64.1 | PATCH | (L2) Ensure 'Turn off Push To Install service' is set to 'Enabled'"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\PushToInstall
      name: DisablePushToInstall
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_64_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.64.1
      - patch
      - pushtoinstall

- name: "18.9.65.2.2 | PATCH | Ensure Do not allow passwords to be saved is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: DisablePasswordSaving
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_2_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.2.2
      - patch
      - terminalservices

- name: "18.9.65.3.2.1 | PATCH | Ensure Restrict Remote Desktop Services users to a single Remote Desktop Services session is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fSingleSessionPerUser
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_2_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.65.3.2.1
      - patch
      - terminalservices

- name: "18.9.65.3.3.1 | PATCH | Ensure Do not allow COM port redirection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fDisableCcm
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_3_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.65.3.3.1
      - patch
      - terminalservices

- name: "18.9.65.3.3.2 | PATCH | Ensure Do not allow drive redirection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fDisableCdm
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_3_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.3.2
      - patch
      - terminalservices

- name: "18.9.65.3.3.3 | PATCH | Ensure Do not allow LPT port redirection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fDisableLPT
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_3_3
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.65.3.3.3
      - patch
      - terminalservices

- name: "18.9.65.3.3.4 | PATCH | Ensure Do not allow supported Plug and Play device redirection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fDisablePNPRedir
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_3_4
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.65.3.3.4
      - patch
      - terminalservicess

- name: "18.9.65.3.9.1 | PATCH | Ensure Always prompt for password upon connection is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fPromptForPassword
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_9_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.9.1
      - patch
      - terminalservices

- name: "18.9.65.3.9.2 | PATCH | Ensure Require secure RPC communication is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: fEncryptRPCTraffic
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_9_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.9.2
      - patch
      - terminalservices

- name: "18.9.65.3.9.3 | PATCH | Ensure Require use of specific security layer for remote RDP connections is set to Enabled SSL"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: SecurityLayer
      data: 2
      type: dword
  when:
      - win19cis_rule_18_9_65_3_9_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.9.3
      - patch
      - terminalservices

- name: "18.9.65.3.9.4 | PATCH | Ensure Require user authentication for remote connections by using Network Level Authentication is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: UserAuthentication
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_9_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.9.4
      - patch
      - terminalservices

- name: "18.9.65.3.9.5 | PATCH | Ensure Set client connection encryption level is set to Enabled High Level"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: MinEncryptionLevel
      data: 3
      type: dword
  when:
      - win19cis_rule_18_9_65_3_9_5
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.9.5
      - patch
      - terminalservices

- name: "18.9.65.3.10.1 | PATCH | Ensure Set time limit for active but idle Remote Desktop Services sessions is set to Enabled 15 minutes or less"
  block:
      - name: "18.9.65.3.10.1 | AUDIT | Ensure Set time limit for active but idle Remote Desktop Services sessions is set to Enabled 15 minutes or less | Warning Check For Variable Standards."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid time set for win19cis_idle_rdp_session_disconnect_time please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - win19cis_idle_rdp_session_disconnect_time == 0 or
              win19cis_idle_rdp_session_disconnect_time > 900000

      - name: "18.9.65.3.10.1 | AUDIT | Ensure Set time limit for active but idle Remote Desktop Services sessions is set to Enabled 15 minutes or less | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: '18.9.65.3.10.1'
        when:
            - win19cis_idle_rdp_session_disconnect_time == 0 or
              win19cis_idle_rdp_session_disconnect_time > 900000

      - name: "18.9.65.3.10.1 | PATCH | Ensure Set time limit for active but idle Remote Desktop Services sessions is set to Enabled 15 minutes or less | Set Variable."
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
            name: MaxIdleTime
            data: "{{ win19cis_idle_rdp_session_disconnect_time }}"
            type: dword
        when:
            - win19cis_idle_rdp_session_disconnect_time == 60000 or
              win19cis_idle_rdp_session_disconnect_time == 300000 or
              win19cis_idle_rdp_session_disconnect_time == 600000 or
              win19cis_idle_rdp_session_disconnect_time == 900000
  when:
      - win19cis_rule_18_9_65_3_10_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.65.3.10.1
      - patch
      - terminalservices

- name: "18.9.65.3.10.2 | PATCH | Ensure Set time limit for disconnected sessions is set to Enabled 1 minute"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: MaxDisconnectionTime
      data: 60000
      type: dword
  when:
      - win19cis_rule_18_9_65_3_10_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.65.3.10.2
      - patch
      - terminalservices

- name: "18.9.65.3.11.1 | PATCH | Ensure Do not delete temp folders upon exit is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: DeleteTempDirsOnExit
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_11_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.11.1
      - patch
      - terminalservices

- name: "18.9.65.3.11.2 | PATCH | Ensure Do not use temporary folders per session is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
      name: PerSessionTempDir
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_65_3_11_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.65.3.11.2
      - patch
      - terminalservices

- name: "18.9.66.1 | PATCH | Ensure Prevent downloading of enclosures is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Internet Explorer\Feeds
      name: DisableEnclosureDownload
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_66_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.66.1
      - patch
      - enclosure

- name: "18.9.67.2 | PATCH | Ensure Allow Cloud Search is set to Enabled Disable Cloud Search"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Windows Search
      name: AllowCloudSearch
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_67_2
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.67.2
      - patch
      - search
      - cloud

- name: "18.9.67.3 | PATCH | Ensure Allow indexing of encrypted files is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Windows Search
      name: AllowIndexingEncryptedStoresOrItems
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_67_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.67.3
      - patch
      - search
      - encrypted

- name: "18.9.72.1 | PATCH | Ensure Turn off KMS Client Online AVS Validation is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Nt\Currentversion\Software Protection Platform
      name: NoGenTicket
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_72_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.72.1
      - patch
      - kms

- name: "18.9.85.1.1 | PATCH | Ensure Configure Windows Defender SmartScreen is set to Enabled Warn and prevent bypass"
  block:
      - name: "18.9.85.1.1 | PATCH | Ensure Configure Windows Defender SmartScreen is set to Enabled Warn and prevent bypass | EnableSmartScreen"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\System
            name: EnableSmartScreen
            data: 1
            type: dword

      - name: "18.9.85.1.1 | PATCH | Ensure Configure Windows Defender SmartScreen is set to Enabled Warn and prevent bypass | ShellSmartScreenLevel"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\System
            name: ShellSmartScreenLevel
            data: Block
            type: string
  when:
      - win19cis_rule_18_9_85_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.85.1.1
      - patch
      - defender

- name: "18.9.89.1 | PATCH | Ensure Allow suggested apps in Windows Ink Workspace is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\WindowsInkWorkspace
      name: AllowSuggestedAppsInWindowsInkWorkspace
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_89_1
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.89.1
      - patch
      - wik

- name: "18.9.89.2 | PATCH | Ensure Allow Windows Ink Workspace is set to Enabled On but disallow access above lock OR Disabled but not Enabled On"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsInkWorkspace
      name: AllowWindowsInkWorkspace
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_89_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.89.2
      - patch
      - wik

- name: "18.9.90.1 | PATCH | Ensure Allow user control over installs is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Installer
      name: EnableUserControl
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_90_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.90.1
      - patch

- name: "18.9.90.2 | PATCH | Ensure Always install with elevated privileges is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Installer
      name: AlwaysInstallElevated
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_90_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.90.2
      - patch

- name: "18.9.90.3 | PATCH | Ensure Prevent Internet Explorer security prompt for Windows Installer scripts is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Installer
      name: SafeForScripting
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_90_3
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.90.3
      - patch
      - ie

- name: "18.9.91.1 | PATCH | Ensure Sign-in last interactive user automatically after a system-initiated restart is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
      name: DisableAutomaticRestartSignOn
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_91_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.91.1
      - patch
      - logon

- name: "19.9.100.1 | PATCH | Ensure Turn on PowerShell Script Block Logging is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
      name: EnableScriptBlockLogging
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_100_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.100.1
      - patch
      - powershell

- name: "18.9.100.2 | PATCH | Ensure Turn on PowerShell Transcription is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Powershell\Transcription
      name: EnableTranscripting
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_100_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.100.2
      - patch
      - powershell

- name: "18.9.102.1.1 | PATCH | Ensure Allow Basic authentication is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Client
      name: AllowBasic
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_102_1_1
      - not win_skip_for_test
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.1.1
      - patch
      - winrm

- name: "18.9.102.1.2 | PATCH | Ensure Allow unencrypted traffic is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Client
      name: AllowUnencryptedTraffic
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_102_1_2
      - not win_skip_for_test
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.1.2
      - patch
      - winrm

- name: "18.9.102.1.3 | PATCH | Ensure Disallow Digest authentication is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Client
      name: AllowDigest
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_102_1_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.1.3
      - patch
      - winrm

- name: "18.9.102.2.1 | PATCH | Ensure Allow Basic authentication is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
      name: AllowBasic
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_102_2_1
      - not win_skip_for_test
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.2.1
      - patch
      - winrm

# This control will have to be set to Enabled (1) to allow for continued remote management via Ansible following machine restart
- name: "18.9.102.2.2 | PATCH | Ensure Allow remote server management through WinRM is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
      name: AllowAutoConfig
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_102_2_2
      - not win_skip_for_test
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.102.2.2
      - patch
      - winrm

- name: "18.9.102.2.3 | PATCH | Ensure Allow unencrypted traffic is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
      name: AllowUnencryptedTraffic
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_102_2_3
      - not win_skip_for_test
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.2.3
      - patch
      - winrm
      - encryption

- name: "18.9.102.2.4 | PATCH | Ensure Disallow WinRM from storing RunAs credentials is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
      name: DisableRunAs
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_102_2_4
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.2.4
      - patch
      - winrm

- name: "18.9.103.1 | PATCH | Ensure Allow Remote Shell Access is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service\Winrs
      name: AllowRemoteShellAccess
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_103_1
      - not win_skip_for_test
  tags:
      - level2-domaincontroller
      - level2-memberserver
      - rule_18.9.103.1
      - patch
      - winrm

- name: "18.9.105.2.1 | PATCH | Ensure Prevent users from modifying settings is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows Defender Security Center\App and Browser protection
      name: DisallowExploitProtectionOverride
      data: 1
      type: dword
  when:
      - win19cis_rule_18_9_105_2_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.105.2.1
      - patch
      - accounts

- name: "18.9.108.1.1 | PATCH | Ensure No auto-restart with logged on users for scheduled automatic updates installations is set to Disabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Windowsupdate\Au
      name: NoAutoRebootWithLoggedOnUsers
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_108_1_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.108.1.1
      - patch
      - winupdate

- name: "18.9.108.2.1 | PATCH | Ensure Configure Automatic Updates is set to Enabled"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Windowsupdate\Au
      name: NoAutoUpdate
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_108_2_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.108.2.1
      - patch
      - winupdate

- name: "18.9.108.2.2 | PATCH | Ensure Configure Automatic Updates Scheduled install day is set to 0 - Every day"
  ansible.windows.win_regedit:
      path: HKLM:\Software\Policies\Microsoft\Windows\Windowsupdate\Au
      name: ScheduledInstallDay
      data: 0
      type: dword
  when:
      - win19cis_rule_18_9_108_2_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.108.2.2
      - patch
      - winupdate

- name: "18.9.108.4.1 | PATCH | Ensure Manage preview builds is set to Enabled Disable preview builds"
  block:
      - name: "18.9.108.4.1 | PATCH | Ensure Manage preview builds is set to Enabled Disable preview builds | ManagePreviewBuilds"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
            name: ManagePreviewBuilds
            data: 1
            type: dword

      - name: "18.9.108.4.1 | PATCH | Ensure Manage preview builds is set to Enabled Disable preview builds | ManagePreviewBuilds"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
            name: ManagePreviewBuildsPolicyValue
            data: 0
            type: dword
  when:
      - win19cis_rule_18_9_108_4_1
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.102.1.1
      - patch
      - winupdate

- name: "18.9.108.4.2 | PATCH | Ensure 'Select when Preview Builds and Feature Updates are received' is set to 'Enabled: 180 or more days'"
  block:
      - name: "18.9.108.4.2 | PATCH | Ensure 'Select when Preview Builds and Feature Updates are received' is set to 'Enabled: 180 or more days' | DeferFeatureUpdates"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
            name: DeferFeatureUpdates
            data: 1
            type: dword

      - name: "18.9.108.4.2 | PATCH | Ensure 'Select when Preview Builds and Feature Updates are received' is set to 'Enabled: 180 or more days' | DeferFeatureUpdatesPeriodInDays"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
            name: DeferFeatureUpdatesPeriodInDays
            data: 180
            type: dword

      - name: "18.9.108.4.2 | PATCH | Ensure 'Select when Preview Builds and Feature Updates are received' is set to 'Enabled: 180 or more days' | BranchReadinessLevel"
        ansible.windows.win_regedit:
            path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
            name: BranchReadinessLevel
            data: 16
            type: dword
  when:
      - win19cis_rule_18_9_108_4_2
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.108.4.2
      - patch
      - winupdate

- name: "18.9.108.4.3 | PATCH | Ensure Select when Quality Updates are received is set to Enabled 0 days"
  block:
      - name: "18.9.108.4.3 | PATCH | Ensure Select when Quality Updates are received is set to Enabled 0 days | DeferQualityUpdates"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
            name: DeferQualityUpdates
            data: 1
            type: dword

      - name: "18.9.108.4.3 | PATCH | Ensure Select when Quality Updates are received is set to Enabled 0 days | DeferQualityUpdatesPeriodInDays"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
            name: DeferQualityUpdatesPeriodInDays
            data: 0
            type: dword
  when:
      - win19cis_rule_18_9_108_4_3
  tags:
      - level1-domaincontroller
      - level1-memberserver
      - rule_18.9.108.4.3
      - patch
      - winupdate
